@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@model Nadasdladany.ViewModels.NewsIndexViewModel

@{
    ViewData["Title"] = "Hírek";
    var pageTitle = string.IsNullOrEmpty(Model.CurrentCategoryName) ? "Összes Hír" : $"Hírek: {Model.CurrentCategoryName}";
}

<div class="container mt-4">

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">@TempData["SuccessMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">@TempData["ErrorMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
    }

    <div class="row">
        <!-- Main Content Area (col-lg-9) -->
        <div class="col-lg-9">
            <header class="mb-4">
                <h1 class="section-title-primary">@pageTitle</h1>
                @if (!string.IsNullOrEmpty(Model.CurrentCategorySlug))
                {
                    <a asp-controller="News" asp-action="Index" class="btn btn-sm btn-outline-secondary mb-3"><i class="bi bi-x-circle me-1"></i>Szűrés törlése (Összes hír)</a>
                }
            </header>

            <!-- FIX: Added this row to correctly wrap the card grid columns -->
            <div class="row g-4">
                @if (SignInManager.IsSignedIn(User) && User.IsInRole("Administrator"))
                {
                    <div class="col-md-6 d-flex">
                        <div class="card h-100 card-add-new" data-bs-toggle="modal" data-bs-target="#addNewsModal" title="Új hír létrehozása">
                            <div class="card-body d-flex flex-column align-items-center justify-content-center">

                                <div class="admin-add-button">
                                    <i class="bi bi-plus-lg"></i>
                                </div>
                                <span class="d-block mt-3 text-muted fw-bold">Új hír hozzáadása</span>

                            </div>

                        </div>
                    </div>
                }

                @if (Model.Articles.Any())
                {
                    @foreach (var article in Model.Articles)
                    {
                        <div class="col-md-6 d-flex"><partial name="_ArticleCard" model="article" /></div>
                    }
                }
                else if (!User.IsInRole("Administrator"))
                {
                    <div class="col-12"><div class="alert alert-info">Jelenleg nincsenek elérhető hírek ebben a kategóriában.</div></div>
                }
            </div> <!-- FIX: This is the closing tag for the new "row g-4" -->
            @if (Model.TotalPages > 1)
            {
                <nav aria-label="Page navigation" class="mt-5">
                    <ul class="pagination justify-content-center">
                        @if (Model.HasPreviousPage)
                        {
                            <li class="page-item"><a class="page-link" asp-action="Index" asp-route-categorySlug="@Model.CurrentCategorySlug" asp-route-page="@(Model.CurrentPage - 1)">Előző</a></li>
                        }
                        else
                        {
                            <li class="page-item disabled"><span class="page-link">Előző</span></li>
                        }
                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")"><a class="page-link" asp-action="Index" asp-route-categorySlug="@Model.CurrentCategorySlug" asp-route-page="@i">@i</a></li>
                        }
                        @if (Model.HasNextPage)
                        {
                            <li class="page-item"><a class="page-link" asp-action="Index" asp-route-categorySlug="@Model.CurrentCategorySlug" asp-route-page="@(Model.CurrentPage + 1)">Következő</a></li>
                        }
                        else
                        {
                            <li class="page-item disabled"><span class="page-link">Következő</span></li>
                        }
                    </ul>
                </nav>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <aside class="sticky-top" style="top: 80px;">
                <div class="p-3 bg-light shadow-sm rounded mt-4 mt-lg-0">
                    <h4 class="section-title-secondary mb-3"><i class="bi bi-tags-fill me-2"></i>Kategóriák</h4>
                    @if (Model.Categories.Any())
                    {
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item @(string.IsNullOrEmpty(Model.CurrentCategorySlug) ? "active" : "")"><a asp-controller="News" asp-action="Index" class="text-decoration-none @(string.IsNullOrEmpty(Model.CurrentCategorySlug) ? "text-white fw-bold" : "")">Összes hír</a></li>
                            @foreach (var category in Model.Categories)
                            {
                                <li class="list-group-item @(Model.CurrentCategorySlug == category.Slug ? "active" : "")"><a asp-controller="News" asp-action="Index" asp-route-categorySlug="@category.Slug" class="text-decoration-none @(Model.CurrentCategorySlug == category.Slug ? "text-white fw-bold" : "")">@category.Name</a></li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p>Nincsenek kategóriák.</p>
                    }
                </div>
            </aside>
        </div>
    </div>
</div>

@if (SignInManager.IsSignedIn(User) && User.IsInRole("Administrator"))
{
    @* "ADD NEWS" MODAL *@
    <div class="modal fade" id="addNewsModal" tabindex="-1" aria-labelledby="addNewsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form asp-controller="News" asp-action="Create" method="post">
                    <div class="modal-header"><h5 class="modal-title" id="addNewsModalLabel">Új hír létrehozása</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                    <div class="modal-body">
                        @Html.AntiForgeryToken()
                        <div class="mb-3"><label for="Title" class="form-label">Cím</label><input type="text" id="Title" name="Title" class="form-control" required></div>
                        <div class="mb-3"><label for="Content" class="form-label">Teljes tartalom</label><textarea id="Content" name="Content" class="form-control" rows="10" required></textarea><div class="form-text">Használhatsz HTML tageket a formázáshoz.</div></div>
                        <div class="mb-3"><label for="Excerpt" class="form-label">Rövid kivonat (opcionális)</label><textarea id="Excerpt" name="Excerpt" class="form-control" rows="3"></textarea></div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="CategoryId" class="form-label">Kategória</label><select id="CategoryId" name="CategoryId" class="form-select" required>
                                    <option value="">Válassz kategóriát...</option>@foreach (var category in Model.Categories){
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                        </div><div class="col-md-6 mb-3"><label for="FeaturedImageUrl" class="form-label">Kiemelt kép URL (opcionális)</label><input type="text" id="FeaturedImageUrl" name="FeaturedImageUrl" class="form-control" placeholder="/img/hirek/kep-neve.jpg"></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button><button type="submit" class="btn btn-primary">Hír közzététele</button></div>
            </form>
        </div>
    </div>
</div>

@* "EDIT NEWS" MODAL *@
<div class="modal fade" id="editNewsModal" tabindex="-1" aria-labelledby="editNewsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-controller="News" asp-action="Edit" method="post">
                <div class="modal-header"><h5 class="modal-title" id="editNewsModalLabel">Hír szerkesztése</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="editArticleId" name="Id" />
                    <div class="mb-3"><label for="editTitle" class="form-label">Cím</label><input type="text" id="editTitle" name="Title" class="form-control" required></div>
                    <div class="mb-3"><label for="editContent" class="form-label">Teljes tartalom</label><textarea id="editContent" name="Content" class="form-control" rows="10" required></textarea></div>
                    <div class="mb-3"><label for="editExcerpt" class="form-label">Rövid kivonat</label><textarea id="editExcerpt" name="Excerpt" class="form-control" rows="3"></textarea></div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCategoryId" class="form-label">Kategória</label><select id="editCategoryId" name="CategoryId" class="form-select" required>
                                @foreach (var category in Model.Categories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                        </div><div class="col-md-6 mb-3"><label for="editFeaturedImageUrl" class="form-label">Kiemelt kép URL</label><input type="text" id="editFeaturedImageUrl" name="FeaturedImageUrl" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button><button type="submit" class="btn btn-primary">Módosítások mentése</button></div>
            </form>
        </div>
    </div>
</div>

@* "DELETE CONFIRMATION" MODAL *@
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-controller="News" asp-action="Delete" method="post">
                <div class="modal-header"><h5 class="modal-title" id="deleteConfirmModalLabel">Törlés megerősítése</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">@Html.AntiForgeryToken()<input type="hidden" id="deleteArticleId" name="Id" /><p>Biztosan törölni szeretné a következő hírt? <br /><strong id="deleteArticleTitle"></strong></p><p class="text-danger">A művelet nem vonható vissza!</p></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button><button type="submit" class="btn btn-danger">Igen, törlöm</button></div>
            </form>
        </div>
    </div>
</div>
}


@section Scripts {
    <script>
        function stripHtml(html) {
            if (!html) return "";
            let tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || "";
        }

        document.addEventListener('DOMContentLoaded', function () {

            // --- Logic for the EDIT modal ---
            var editModal = document.getElementById('editNewsModal');
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;

                    // Get data from attributes
                    var articleId = button.getAttribute('data-article-id');
                    var title = button.getAttribute('data-article-title');
                    var content = button.getAttribute('data-article-content'); // Contains HTML
                    var excerpt = button.getAttribute('data-article-excerpt'); // May contain HTML
                    var imageUrl = button.getAttribute('data-article-imageurl');
                    var categoryId = button.getAttribute('data-article-categoryid');

                    // Clean the content using the helper function
                    var plainTextContent = stripHtml(content);
                    var plainTextExcerpt = stripHtml(excerpt);

                    // Update the modal's content with the cleaned text
                    editModal.querySelector('.modal-title').textContent = 'Szerkesztés: ' + title;
                    editModal.querySelector('#editArticleId').value = articleId;
                    editModal.querySelector('#editTitle').value = title;
                    editModal.querySelector('#editContent').value = plainTextContent;
                    editModal.querySelector('#editExcerpt').value = plainTextExcerpt;
                    editModal.querySelector('#editFeaturedImageUrl').value = imageUrl;
                    editModal.querySelector('#editCategoryId').value = categoryId;
                });
            }

            // --- Logic for the DELETE modal (no changes here) ---
            var deleteModal = document.getElementById('deleteConfirmModal');
            if (deleteModal) {
                deleteModal.addEventListener('show.bs.modal', function(event) {
                    var button = event.relatedTarget;
                    var articleId = button.getAttribute('data-article-id');
                    var articleTitle = button.getAttribute('data-article-title');

                    deleteModal.querySelector('#deleteArticleTitle').textContent = articleTitle;
                    deleteModal.querySelector('#deleteArticleId').value = articleId;
                });
            }
        });
    </script>
}